<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.mes2.mappers.QualityDefectStatisticsMapper">

  <!-- ✅ 전체 요약 (완제품 기준 + STATUS='VOIDED'만 포함) -->
  <select id="getSummary" resultType="kr.or.mes2.dto.QualityDefectStatisticsDTO">
    SELECT
        -- ✅ 완제품 전체 검사 수량 (INVENTORY_TRANSACTION 기준)
        NVL(SUM(CASE WHEN IM.ITEM_TYPE_CODE = 'PCD' THEN INV.QTY ELSE 0 END), 0) AS finishedGoodQty,

        -- ✅ 불량 수량 (QUALITY_DEFECT에서 STATUS='VOIDED'만)
        NVL(SUM(CASE 
                  WHEN IM.ITEM_TYPE_CODE = 'PCD' 
                       AND D.STATUS = 'VOIDED' 
                  THEN D.DEFECT_QTY ELSE 0 END), 0) AS defectQty,

        -- ✅ 불량률 (완제품 기준)
        ROUND(
          CASE 
            WHEN NVL(SUM(CASE WHEN IM.ITEM_TYPE_CODE = 'PCD' THEN INV.QTY ELSE 0 END), 0) = 0 THEN 0
            ELSE (
              NVL(SUM(CASE 
                        WHEN IM.ITEM_TYPE_CODE = 'PCD' AND D.STATUS = 'VOIDED' 
                        THEN D.DEFECT_QTY ELSE 0 END), 0)
              / NVL(SUM(CASE WHEN IM.ITEM_TYPE_CODE = 'PCD' THEN INV.QTY ELSE 0 END), 0)
            ) * 100
          END, 2
        ) AS defectRate
    FROM QUALITY_DEFECT D
    JOIN QUALITY_INSPECTION I 
      ON D.INSPECT_ID = I.INSPECTION_ID   <!-- ✅ 수정: INSPECTION_ID → INSPECT_ID -->
    JOIN INVENTORY_TRANSACTION INV 
      ON I.TXN_ID = INV.TXN_ID
    JOIN ITEM_MASTER IM 
      ON INV.ITEM_ID = IM.ITEM_ID
    WHERE IM.ITEM_TYPE_CODE = 'PCD'
      AND D.STATUS = 'VOIDED'
  </select>


  <!-- ✅ 완제품/반제품별 불량률 비교 -->
  <select id="getProductTypeDefectRate" parameterType="string" resultType="map">
    SELECT 
        CASE 
          WHEN IM.ITEM_TYPE_CODE = 'PCD' THEN '완제품'
          WHEN IM.ITEM_TYPE_CODE = 'SGD' THEN '반제품'
          ELSE '기타' 
        END AS PRODUCT_TYPE,
        NVL(SUM(INV.QTY), 0) AS GOOD_QTY,
        NVL(SUM(CASE WHEN D.STATUS = 'VOIDED' THEN D.DEFECT_QTY ELSE 0 END), 0) AS DEFECT_QTY,
        ROUND(
          CASE 
            WHEN NVL(SUM(INV.QTY), 0) = 0 THEN 0
            ELSE (SUM(CASE WHEN D.STATUS = 'VOIDED' THEN D.DEFECT_QTY ELSE 0 END)
                 / SUM(INV.QTY)) * 100
          END, 2
        ) AS DEFECT_RATE
    FROM QUALITY_DEFECT D
    JOIN QUALITY_INSPECTION I 
      ON D.INSPECT_ID = I.INSPECTION_ID   <!-- ✅ 동일하게 수정 -->
    JOIN INVENTORY_TRANSACTION INV 
      ON I.TXN_ID = INV.TXN_ID
    JOIN ITEM_MASTER IM 
      ON INV.ITEM_ID = IM.ITEM_ID
    WHERE IM.ITEM_TYPE_CODE = #{type}
      AND D.STATUS = 'VOIDED'
    GROUP BY IM.ITEM_TYPE_CODE
    ORDER BY PRODUCT_TYPE
  </select>

</mapper>
