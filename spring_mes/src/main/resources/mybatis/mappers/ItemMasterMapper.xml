<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.mes2.mapper.ItemMasterMapper">

    <!-- 매핑 -->
    <resultMap id="ItemMasterMap" type="kr.or.mes2.dto.ItemMasterDTO">
        <id property="itemId" column="ITEM_ID" />
        <result property="itemName" column="ITEM_NAME" />
        <result property="lotPrefix" column="LOT_PREFIX" />
        <result property="itemTypeCode" column="ITEM_TYPE_CODE" />
        <result property="detailCode" column="ITEM_DETAIL_CODE" />
        <result property="specification" column="SPECIFICATION" />  <!-- ✅ 수정 -->
        <result property="unit" column="UNIT" />
        <result property="expDate" column="EXPIRY_DAYS" />
        <result property="detailName" column="DETAIL_NAME" />
    </resultMap>

    <!-- 공통 검색 where -->
    <sql id="ItemMasterWhere">
        <where>
            <if test="keyword != null and keyword != ''">
                (UPPER(i.item_name) LIKE '%' || UPPER(#{keyword}) || '%'
                OR UPPER(i.item_type_code) LIKE '%' || UPPER(#{keyword}) || '%'
                OR UPPER(i.item_detail_code) LIKE '%' || UPPER(#{keyword}) || '%')
            </if>
            <if test="typeFilter != null and typeFilter != ''">
                AND i.item_type_code = #{typeFilter}
            </if>
        </where>
    </sql>

    <!-- 제품 목록 -->
    <select id="listItem" parameterType="map" resultMap="ItemMasterMap">
        SELECT
            i.item_id,
            i.item_name,
            i.lot_prefix,
            i.item_type_code,
            i.item_detail_code,
            i.unit,
            i.specification,
            i.expiry_days,
            dcd.detail_name AS detail_name
        FROM ITEM_MASTER i
        LEFT JOIN CODE_DETAIL dcd
            ON i.item_detail_code = dcd.detail_code
            AND dcd.use_yn = 'Y'
        <include refid="ItemMasterWhere" />
        ORDER BY i.item_id DESC
    </select>

    <!-- 단일 조회 -->
    <select id="getItemById" parameterType="int" resultMap="ItemMasterMap">
        SELECT
            i.item_id,
            i.item_name,
            i.lot_prefix,
            i.item_type_code,
            i.item_detail_code,
            i.unit,
            i.specification,
            i.expiry_days,
            dcd.detail_name AS detail_name
        FROM ITEM_MASTER i
        LEFT JOIN CODE_DETAIL dcd
            ON i.item_detail_code = dcd.detail_code
            AND dcd.use_yn = 'Y'
        WHERE i.item_id = #{itemId}
    </select>

    <!-- 다음 ID -->
    <select id="getNextItemId" resultType="int">
        SELECT NVL(MAX(item_id), 0) + 1 FROM ITEM_MASTER
    </select>

    <!-- 등록 -->
    <insert id="insertItem" parameterType="kr.or.mes2.dto.ItemMasterDTO">
        INSERT INTO ITEM_MASTER
        (item_id, item_name, lot_prefix, item_type_code, item_detail_code, specification, unit, expiry_days)
        VALUES (
            #{itemId},
            #{itemName},
            #{lotPrefix},
            #{itemTypeCode},
            #{detailCode},
            #{specification},
            #{unit},
            #{expDate}
        )
    </insert>

    <!-- 수정 -->
    <update id="updateItem" parameterType="kr.or.mes2.dto.ItemMasterDTO">
        UPDATE ITEM_MASTER
        SET item_name = #{itemName},
            lot_prefix = #{lotPrefix},
            item_type_code = #{itemTypeCode},
            item_detail_code = #{detailCode},
            specification = #{specification},  <!-- ✅ 수정 -->
            unit = #{unit},
            expiry_days = #{expDate}
        WHERE item_id = #{itemId}
    </update>

    <!-- 삭제 -->
    <delete id="deleteItem" parameterType="int">
        DELETE FROM ITEM_MASTER
        WHERE item_id = #{itemId}
    </delete>

    <!-- 제품유형 마스터 코드 목록 -->
    <select id="listItemKindMasterCodes" resultType="kr.or.mes2.dto.CodeDTO">
        SELECT code_id AS codeId, code_name AS codeName
        FROM CODE_MASTER
        WHERE code_id IN ('PCD', 'SGD', 'RMD')
        ORDER BY code_id
    </select>

    <!-- 활성화된 상세코드 목록 -->
    <select id="listActiveItemKindCodes" resultType="kr.or.mes2.dto.CodeDTO">
        SELECT
            d.detail_code AS detailCode,
            d.detail_name AS detailName
        FROM CODE_DETAIL d
        WHERE d.code_id IN ('PCD', 'SGD', 'RMD')
          AND d.use_yn = 'Y'
        ORDER BY d.detail_code
    </select>

   <select id="listAvailableDetailCodes" resultType="kr.or.mes2.dto.CodeDTO" parameterType="string">
    SELECT
        d.detail_code AS detailCode,
        d.detail_name AS detailName
    FROM CODE_DETAIL d
    WHERE d.code_id = #{codeId}
      AND d.use_yn = 'Y'
    ORDER BY d.detail_code
</select>

</mapper>
