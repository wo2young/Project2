<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.mes2.mapper.TargetMapper">

  <!-- 생산 목표 리스트 조회 -->
  <select id="getTargetList" parameterType="map" resultType="TargetDTO">
    SELECT 
      T.TARGET_ID,
      T.ITEM_ID,
      I.ITEM_NAME,
      T.START_DATE,
      T.END_DATE,
      T.TARGET_QTY,
      U.NAME AS CREATED_BY_NAME
    FROM PRODUCTION_TARGET T
    JOIN ITEM_MASTER I ON T.ITEM_ID = I.ITEM_ID
    LEFT JOIN USER_T U ON T.CREATED_BY = U.USER_ID
    WHERE 1=1
      <if test="searchStart != null and searchStart != ''">
        AND T.START_DATE &gt;= TO_DATE(#{searchStart}, 'YYYY-MM-DD')
      </if>
      <if test="searchEnd != null and searchEnd != ''">
        AND T.END_DATE &lt;= TO_DATE(#{searchEnd}, 'YYYY-MM-DD')
      </if>
    ORDER BY T.TARGET_ID DESC
  </select>

  <!-- 품목 목록 조회 (PCD 타입만) -->
  <select id="getPCDitems" resultType="TargetDTO">
    SELECT ITEM_ID, ITEM_NAME 
    FROM ITEM_MASTER 
    WHERE ITEM_TYPE_CODE = 'PCD'
    ORDER BY ITEM_ID
  </select>

  <!-- 생산 목표 등록 (시퀀스 없이 MAX+1 방식) -->
  <insert id="insertTarget" parameterType="TargetDTO">
    INSERT INTO PRODUCTION_TARGET
      (TARGET_ID, ITEM_ID, START_DATE, END_DATE, TARGET_QTY, CREATED_AT, CREATED_BY)
    VALUES (
      (SELECT NVL(MAX(TARGET_ID),0) + 1 FROM PRODUCTION_TARGET),
      #{itemId},
      #{startDate},
      #{endDate},
      #{targetQty},
      SYSDATE,
      #{createdBy}
    )
  </insert>

  <!-- 생산 목표 수정 -->
  <update id="updateTarget" parameterType="TargetDTO">
    UPDATE PRODUCTION_TARGET
    SET 
        START_DATE = #{startDate},
        END_DATE = #{endDate},
        TARGET_QTY = #{targetQty}
    WHERE TARGET_ID = #{targetId}
  </update>

  <!-- 생산 목표 삭제 -->
  <delete id="deleteTarget" parameterType="int">
    DELETE FROM PRODUCTION_TARGET 
    WHERE TARGET_ID = #{targetId}
  </delete>
  <!-- ✅ 생산지시 총합 조회 (수정 시 검증용) -->
  <select id="getOrderQtySumByTarget" parameterType="int" resultType="int">
    SELECT NVL(SUM(ORDER_QTY), 0)
    FROM PRODUCTION_ORDER
    WHERE TARGET_ID = #{targetId}
  </select>

</mapper>
