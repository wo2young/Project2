<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.mes2.mappers.QualityDefectMapper">

  <!-- ✅ 불량 목록 조회 -->
  <select id="getDefectList" resultType="QualityDefectDTO">
    SELECT 
        D.DEFECT_ID        AS defectId,
        D.INSPECT_ID       AS inspectId,
        I.ITEM_NAME        AS itemName,
        D.DEFECT_TYPE      AS defectType,
        D.DEFECT_QTY       AS defectQty,
        D.DEFECT_REASON    AS defectReason,
        D.STATUS           AS status,
        U.NAME             AS inspectorName,
        TO_CHAR(D.CREATED_AT, 'YYYY-MM-DD HH24:MI') AS createdAt
    FROM QUALITY_DEFECT D
    LEFT JOIN QUALITY_INSPECTION QI ON D.INSPECT_ID = QI.INSPECTION_ID
    LEFT JOIN INVENTORY_TRANSACTION T ON QI.TXN_ID = T.TXN_ID
    LEFT JOIN ITEM_MASTER I ON T.ITEM_ID = I.ITEM_ID
    LEFT JOIN USER_T U ON TO_NUMBER(D.APPROVED_BY) = U.USER_ID
    ORDER BY D.CREATED_AT DESC
  </select>

  <!-- ✅ 검사 완료된 인벤토리 목록 (OK도 포함하도록 수정) -->
  <select id="getInventoryList" resultType="QualityDefectDTO">
    SELECT 
        QI.INSPECTION_ID  AS inspectionId,
        QI.TXN_ID         AS txnId,
        I.ITEM_NAME       AS itemName,
        QI.DEFECT_QTY     AS defectQty,
        QI.INSPECTION_RESULT AS inspectionResult
    FROM QUALITY_INSPECTION QI
    LEFT JOIN INVENTORY_TRANSACTION T ON QI.TXN_ID = T.TXN_ID
    LEFT JOIN ITEM_MASTER I ON T.ITEM_ID = I.ITEM_ID
    WHERE 
        <![CDATA[
          NVL((SELECT SUM(D.DEFECT_QTY)
                 FROM QUALITY_DEFECT D
                WHERE D.INSPECT_ID = QI.INSPECTION_ID
                  AND D.STATUS NOT IN ('VOIDED','CONFIRMED')
              ),0) < QI.DEFECT_QTY
        ]]>
    ORDER BY QI.CREATED_AT DESC
  </select>

  <!-- ✅ 불량 코드 목록 -->
  <select id="getDefectCodes" resultType="kr.or.mes2.dto.QualityDefectDTO">
    SELECT 
        DETAIL_CODE AS detailCode,
        DETAIL_NAME AS codeName
    FROM CODE_DETAIL
    WHERE CODE_ID = 'DEF'
      AND USE_YN = 'Y'
    ORDER BY DETAIL_CODE
  </select>

  <!-- ✅ 불량 등록 -->
  <insert id="insertDefect" parameterType="QualityDefectDTO">
    INSERT INTO QUALITY_DEFECT (
        DEFECT_ID,
        INSPECT_ID,
        DEFECT_TYPE,
        DEFECT_QTY,
        DEFECT_REASON,
        STATUS,
        APPROVED_BY,
        CREATED_AT
    ) VALUES (
        #{defectId},
        #{inspectId},
        #{defectType},
        #{defectQty},
        #{defectReason},
        #{status},
        #{approvedBy},
        SYSDATE
    )
  </insert>

  <!-- ✅ 자바에서 PK 생성용 -->
  <select id="getNextDefectId" resultType="int">
    SELECT NVL(MAX(DEFECT_ID), 0) + 1 FROM QUALITY_DEFECT
  </select>

  <!-- ✅ 총 불량 수량 조회 -->
  <select id="getTotalDefectQty" parameterType="int" resultType="int">
    SELECT DEFECT_QTY
    FROM QUALITY_INSPECTION
    WHERE INSPECTION_ID = #{inspectionId}
  </select>

  <!-- ✅ 남은 불량 수량 조회 -->
  <select id="getRemainingDefectQty" parameterType="int" resultType="int">
    SELECT 
        (QI.DEFECT_QTY - NVL((
            SELECT SUM(D.DEFECT_QTY)
            FROM QUALITY_DEFECT D
            WHERE D.INSPECT_ID = QI.INSPECTION_ID
              AND D.STATUS NOT IN ('VOIDED')
        ), 0))
    FROM QUALITY_INSPECTION QI
    WHERE QI.INSPECTION_ID = #{inspectionId}
  </select>

</mapper>
