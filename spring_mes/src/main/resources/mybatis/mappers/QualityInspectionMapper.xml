<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.mes2.mappers.QualityInspectionMapper">

  <!-- âœ… [1] ê²€ì‚¬ ëŒ€ìƒ ëª©ë¡ ì¡°íšŒ -->
  <!-- STATUS='CONFIRMED' â†’ ê²€ì‚¬ ì „ í•­ëª©ë§Œ í‘œì‹œ -->
 <select id="getInventoryList" resultType="kr.or.mes2.dto.QualityInspectionDTO">
  SELECT 
      INV.TXN_ID             AS txnId,
      INV.ITEM_ID            AS itemId,
      INV.QTY                AS quantity,
      INV.STATUS             AS status,
      TO_CHAR(INV.TXN_DATE, 'YYYY-MM-DD HH24:MI:SS') AS txnDate,
      IM.ITEM_NAME           AS itemName,
      IM.ITEM_TYPE_CODE      AS itemTypeCode   <!-- âœ… í’ˆëª©ìƒíƒœ ê¸°ì¤€ ì»¬ëŸ¼ -->
  FROM INVENTORY_TRANSACTION INV
       JOIN ITEM_MASTER IM ON INV.ITEM_ID = IM.ITEM_ID
  WHERE INV.STATUS = 'CONFIRMED'              <!-- âœ… ê²€ì‚¬ ì „ ìƒíƒœë§Œ -->
    AND IM.ITEM_TYPE_CODE != 'RMD'            <!-- ðŸš« ì›ìžìž¬ ì œì™¸ -->
  ORDER BY INV.TXN_ID DESC
</select>


  <!-- âœ… [2] ë“±ë¡ëœ í’ˆì§ˆê²€ì‚¬ ëª©ë¡ (ê²€ì‚¬ ì™„ë£Œ í•­ëª© í¬í•¨) -->
  <select id="getInspectionList" resultType="kr.or.mes2.dto.QualityInspectionDTO">
    SELECT
        INS.INSPECTION_ID      AS inspectionId,
        INS.TXN_ID             AS txnId,
        INS.INSPECTOR_ID       AS inspectorId,
        INS.INSPECT_TYPE       AS inspectType,
        INS.DEFECT_QTY         AS defectQty,
        INS.INSPECTION_RESULT  AS inspectionResult,
        INS.REMARKS            AS remarks,
        TO_CHAR(INS.CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS createdAt,
        INV.ITEM_ID            AS itemId,
        INV.QTY                AS quantity,
        INV.STATUS             AS status,
        TO_CHAR(INV.TXN_DATE, 'YYYY-MM-DD HH24:MI:SS') AS txnDate,
        IM.ITEM_NAME           AS itemName,
        IM.ITEM_TYPE_CODE      AS itemTypeCode   <!-- âœ… í’ˆëª©ìƒíƒœ ê¸°ì¤€ ì»¬ëŸ¼ -->
    FROM QUALITY_INSPECTION INS
         JOIN INVENTORY_TRANSACTION INV ON INS.TXN_ID = INV.TXN_ID
         JOIN ITEM_MASTER IM ON INV.ITEM_ID = IM.ITEM_ID
    ORDER BY INS.INSPECTION_ID DESC
  </select>


  <!-- âœ… [3] í’ˆì§ˆê²€ì‚¬ ë“±ë¡ -->
  <insert id="insertInspection" parameterType="kr.or.mes2.dto.QualityInspectionDTO">
  INSERT INTO QUALITY_INSPECTION (
    INSPECTION_ID,
    TXN_ID,
    INSPECTOR_ID,
    INSPECT_TYPE,
    DEFECT_QTY,
    INSPECTION_RESULT,
    REMARKS,
    CREATED_AT
) VALUES (
    #{inspectionId},
    #{txnId},
    #{inspectorId},
    #{inspectType},
    #{defectQty},
    #{inspectionResult},
    #{remarks},
    SYSDATE + (9/24)
)


  </insert>


  <!-- âœ… [4] ì‹œí€€ìŠ¤ ëŒ€ì²´ìš© ID ìƒì„± (MAX + 1 ë°©ì‹) -->
  <select id="getNextInspectionId" resultType="int">
    SELECT NVL(MAX(INSPECTION_ID), 0) + 1 FROM QUALITY_INSPECTION
  </select>


  <!-- âœ… [5] TXN_ID ê¸°ì¤€ ITEM_TYPE_CODE ì¡°íšŒ (ê²€ì‚¬ìœ í˜• ìžë™ê¸°ìž…ìš©) -->
  <select id="getItemTypeCodeByTxn" parameterType="int" resultType="string">
    SELECT IM.ITEM_TYPE_CODE
    FROM INVENTORY_TRANSACTION INV
         JOIN ITEM_MASTER IM ON INV.ITEM_ID = IM.ITEM_ID
    WHERE INV.TXN_ID = #{txnId}
  </select>
  
  
<!-- âœ… [6] ê²€ì‚¬ ë“±ë¡ ì‹œ INVENTORY ìƒíƒœë¥¼ 'ING'ë¡œ ë³€ê²½ -->
<update id="updateStatusToING" parameterType="int">
  UPDATE INVENTORY_TRANSACTION
  SET STATUS = 'ING'
  WHERE TXN_ID = #{txnId}
</update>

  

</mapper>
